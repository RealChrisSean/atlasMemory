<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>atlasMemory Demo</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --border-color: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --accent: #0ea5e9;
            --accent-hover: #0284c7;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --badge-branch-bg: #e0f2fe;
            --badge-branch-text: #0369a1;
            --badge-source-bg: #ecfccb;
            --badge-source-text: #3f6212;
            --badge-tag-bg: #f3e8ff;
            --badge-tag-text: #7c3aed;
            --highlight-bg: #fef3c7;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --border-color: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #e2e8f0;
            --text-muted: #64748b;
            --accent: #38bdf8;
            --accent-hover: #7dd3fc;
            --badge-branch-bg: #1e3a5f;
            --badge-branch-text: #38bdf8;
            --badge-source-bg: #365314;
            --badge-source-text: #84cc16;
            --badge-tag-bg: #4c1d95;
            --badge-tag-text: #a78bfa;
            --highlight-bg: #422006;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Header */
        header {
            background: var(--bg-primary);
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 { font-size: 1.25rem; font-weight: 600; }
        header h1 span { color: var(--accent); }

        .header-actions { display: flex; gap: 0.5rem; align-items: center; }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
        }
        .btn-sm:hover { background: var(--bg-tertiary); }

        /* Main layout: tutorial sidebar + 3 panels */
        /* Height = viewport minus banner (28px) minus header (53px) minus bottom info (36px) */
        .layout {
            display: grid;
            grid-template-columns: 240px 280px 1fr 1fr;
            height: calc(100vh - 117px);
        }

        /* Tutorial Sidebar */
        .tutorial {
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem 1rem;
            overflow-y: auto;
        }

        .tutorial-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .step {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .step.active {
            background: var(--highlight-bg);
            border-color: var(--warning);
        }

        .step.completed {
            opacity: 0.6;
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            font-size: 0.7rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .step.active .step-number {
            background: var(--warning);
            color: white;
        }

        .step.completed .step-number {
            background: var(--success);
            color: white;
        }

        .step-title {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .step-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
            margin-left: 1.75rem;
        }

        .step-action {
            margin-top: 0.5rem;
            margin-left: 1.75rem;
        }

        .step-action button {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
            border: none;
            background: var(--accent);
            color: white;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .step-action button:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        /* Panels */
        .panel {
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            padding: 1rem;
            overflow-y: auto;
        }

        .panel:last-child { border-right: none; }

        /* Subtle inner shadow at top of panels for depth */
        .panel::before {
            content: '';
            display: block;
            height: 0;
        }

        .panel-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        /* Branch indicator - green left border for main (safe) */
        .branch-indicator {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            padding-left: 1rem;
            background: var(--bg-secondary);
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            font-size: 0.8rem;
            transition: all 0.3s;
            border-left: 4px solid var(--success);
        }

        /* Orange left border for experiment branches (risky zone) */
        .branch-indicator.experiment {
            background: var(--highlight-bg);
            border: 1px solid var(--warning);
            border-left: 4px solid var(--warning);
        }

        .branch-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .branch-indicator.experiment .branch-dot {
            background: var(--warning);
        }

        .branch-name {
            font-weight: 600;
        }

        /* Small label badge next to branch name */
        .branch-label {
            font-size: 0.6rem;
            padding: 0.125rem 0.375rem;
            border-radius: 9999px;
            background: var(--success);
            color: white;
            font-weight: 500;
            flex-shrink: 0;
        }

        /* Orange label for experiment branches */
        .branch-indicator.experiment .branch-label {
            background: var(--warning);
        }

        /* Branch select dropdown - below the indicator */
        .branch-select {
            margin-bottom: 1rem;
        }

        /* Form elements */
        select, input, textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.8rem;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
        }

        textarea { min-height: 80px; resize: vertical; }

        label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .form-group { margin-bottom: 0.75rem; }

        button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            width: 100%;
            transition: all 0.15s ease;
        }
        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }
        .btn-outline:hover { background: var(--bg-tertiary); }

        /* Memory list */
        .memory-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .memory-item.highlight {
            border-color: var(--warning);
            background: var(--highlight-bg);
        }

        .memory-meta {
            display: flex;
            gap: 0.375rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .badge {
            font-size: 0.6rem;
            padding: 0.125rem 0.375rem;
            border-radius: 9999px;
            font-weight: 500;
        }

        .badge-branch { background: var(--badge-branch-bg); color: var(--badge-branch-text); }
        .badge-source { background: var(--badge-source-bg); color: var(--badge-source-text); }
        .badge-tag { background: var(--badge-tag-bg); color: var(--badge-tag-text); }

        /* Search results */
        .search-result {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .search-result.conflict {
            border-color: var(--danger);
            background: #fef2f2;
        }

        [data-theme="dark"] .search-result.conflict {
            background: #450a0a;
        }

        .result-score {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 0.25rem;
        }

        .result-text {
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .score-bar {
            height: 3px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            margin: 0.5rem 0;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: var(--accent);
        }

        /* Search modes */
        .search-modes {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 0.75rem;
        }

        .mode-btn {
            flex: 1;
            padding: 0.375rem;
            font-size: 0.7rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            border-radius: 0.25rem;
            cursor: pointer;
        }

        .mode-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Empty state */
        .empty {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        /* SQL panel: needs display block for max-height animation to work */
        .sql-content { display: block; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
        }

        .toast.visible { opacity: 1; }
        .toast.success { background: #dcfce7; color: #166534; }
        .toast.error { background: #fee2e2; color: #991b1b; }
        .toast.timeline {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%);
            color: #e0f2fe;
            border-left: 4px solid var(--accent);
            padding: 0.75rem 1.25rem;
        }

        [data-theme="dark"] .toast.success { background: #166534; color: #bbf7d0; }
        [data-theme="dark"] .toast.error { background: #991b1b; color: #fecaca; }

        /* Timeline notice - centered, prominent */
        .timeline-notice {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%);
            color: #e0f2fe;
            padding: 1.5rem 2rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            z-index: 200;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        .timeline-notice.visible {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        .timeline-notice .icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .timeline-notice .branch-name {
            color: #38bdf8;
            font-weight: 600;
        }

        /* Bottom info box - pinned to explain TiDB magic */
        .info-box {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #0f172a 0%, #1e3a5f 100%);
            color: #e0f2fe;
            padding: 0.5rem 1.5rem;
            display: flex;
            justify-content: center;
            gap: 2rem;
            font-size: 0.7rem;
            z-index: 50;
        }
        .info-box .item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .info-box .icon {
            font-size: 0.9rem;
        }
        .info-box .highlight {
            color: #38bdf8;
            font-weight: 500;
        }

        /* Top banner - fixed at top, spans full width */
        .top-banner {
            background: linear-gradient(90deg, #0f172a 0%, #1e3a5f 100%);
            color: #e0f2fe;
            text-align: center;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.02em;
        }

        /* Accent color for keywords in banner */
        .top-banner strong {
            color: #38bdf8;
        }

        /* Progress bar container - sits below tutorial title */
        .progress-container {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
        }

        /* Each segment of the 5-step progress bar */
        .progress-segment {
            flex: 1;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            transition: background 0.3s;
        }

        /* Completed segments get accent color */
        .progress-segment.done {
            background: var(--accent);
        }

        /* Current segment pulses subtly */
        .progress-segment.current {
            background: var(--warning);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Step counter text (e.g., "Step 2 of 5") */
        .step-counter {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 0.75rem;
        }

        /* SQL toggle button - subtle until clicked */
        .sql-toggle {
            margin-top: 1rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .sql-toggle:hover {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        /* When SQL is open, style toggle as header - light bg to match content */
        .sql-toggle.open {
            background: #f4f4f5;
            border-color: #e4e4e7;
            color: #52525b;
            border-radius: 0.5rem 0.5rem 0 0;
            border-bottom: none;
        }

        /* SQL code block - light background, smooth reveal */
        .sql-content {
            max-height: 0;
            overflow: hidden;
            padding: 0 1.25rem;
            background: #f4f4f5;
            border-radius: 0 0 0.5rem 0.5rem;
            font-family: 'SF Mono', 'Fira Code', 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
            line-height: 1.7;
            color: #18181b;
            white-space: pre-wrap;
            word-break: break-word;
            border: 1px solid #e4e4e7;
            border-top: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            position: relative;
            transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
        }

        /* Visible state - smooth expand */
        .sql-content.visible {
            max-height: 500px;
            padding: 1rem 1.25rem;
        }

        /* Copy button in top-right corner */
        .sql-content::before {
            content: 'SQL';
            position: absolute;
            top: 0.5rem;
            right: 0.75rem;
            font-size: 0.6rem;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Syntax highlighting - keywords pop in purple, strings in green */
        .sql-content .keyword { color: #7c3aed; font-weight: 600; }
        .sql-content .string { color: #059669; }
        .sql-content .comment { color: #94a3b8; font-style: italic; }

        /* Copy button - small, subtle, appears in toggle bar */
        .copy-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.6rem;
            font-weight: 500;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.15s;
        }
        .copy-btn:hover { opacity: 1; }
        .copy-btn.copied {
            background: var(--success);
        }

        /* Search area wrapper for highlight effect */
        .search-area {
            position: relative;
            padding: 0.75rem;
            margin: -0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            transition: box-shadow 0.3s ease, background 0.3s ease;
        }

        /* Yellow highlight flash for search area */
        @keyframes searchHighlight {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); background: transparent; }
            15% { box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.5); background: rgba(245, 158, 11, 0.08); }
            85% { box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.5); background: rgba(245, 158, 11, 0.08); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); background: transparent; }
        }
        .search-area.highlight {
            animation: searchHighlight 0.8s ease;
        }

        /* Highlight animation for search results panel */
        @keyframes resultsHighlight {
            0% { box-shadow: inset 0 0 0 2px transparent; }
            50% { box-shadow: inset 0 0 0 2px var(--accent); }
            100% { box-shadow: inset 0 0 0 2px transparent; }
        }
        .results-flash {
            animation: resultsHighlight 0.5s ease;
        }

        /* New memory highlight - fades in with accent border */
        @keyframes newMemoryPop {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .memory-item.new {
            animation: newMemoryPop 0.4s ease;
        }

        /* Conflict memory - stronger red glow when just added */
        @keyframes conflictGlow {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6); }
            50% { box-shadow: 0 0 20px 4px rgba(239, 68, 68, 0.4); }
            100% { box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2); }
        }
        .memory-item.conflict.new {
            animation: conflictGlow 0.8s ease;
        }

        /* Branch indicator flash when branch changes */
        @keyframes branchFlash {
            0% { transform: scale(1); }
            30% { transform: scale(1.02); box-shadow: 0 0 12px rgba(245, 158, 11, 0.5); }
            100% { transform: scale(1); }
        }
        .branch-indicator.flash {
            animation: branchFlash 0.5s ease;
        }

        /* Conflict memory gets red glow effect */
        .memory-item.conflict {
            border-color: var(--danger);
            background: #fef2f2;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }

        [data-theme="dark"] .memory-item.conflict {
            background: #450a0a;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
        }

        /* Conflict badge for memory items */
        .badge-conflict {
            background: var(--danger);
            color: white;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 4px rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 8px rgba(239, 68, 68, 0.7); }
        }
    </style>
</head>
<body>
    <!-- Top banner: one-line pitch for TiDB -->
    <div class="top-banner">
        <strong>TiDB</strong>: vector + fulltext + JSON + branching ‚Äî all in one table.
    </div>

    <header>
        <h1>atlas<span>Memory</span></h1>
        <div class="header-actions">
            <button class="btn-sm" onclick="resetDemo()">Reset Demo</button>
            <button class="btn-sm" onclick="toggleTheme()">Toggle Theme</button>
        </div>
    </header>

    <div class="layout">
        <!-- Tutorial Sidebar -->
        <div class="tutorial">
            <div class="tutorial-title">Interactive Demo</div>

            <!-- Progress bar: 5 segments, one per step -->
            <div class="progress-container" id="progressBar">
                <div class="progress-segment current"></div>
                <div class="progress-segment"></div>
                <div class="progress-segment"></div>
                <div class="progress-segment"></div>
                <div class="progress-segment"></div>
            </div>

            <!-- Step counter: "Step 1 of 5" -->
            <div class="step-counter" id="stepCounter">Step 1 of 5</div>

            <div class="step active" id="step1">
                <span class="step-number">1</span>
                <span class="step-title">Explore Main Branch</span>
                <div class="step-desc">See the travel preferences stored in TiDB. Try searching.</div>
                <div class="step-action">
                    <button onclick="doStep1Search()">Search "vacation"</button>
                </div>
            </div>

            <div class="step" id="step2">
                <span class="step-number">2</span>
                <span class="step-title">Fork an Experiment</span>
                <div class="step-desc">Create a branch to test changes without affecting main.</div>
                <div class="step-action">
                    <button onclick="doStep2Fork()">Create Branch</button>
                </div>
            </div>

            <div class="step" id="step3">
                <span class="step-number">3</span>
                <span class="step-title">Add Conflicting Data</span>
                <div class="step-desc">Add a memory that contradicts existing preferences.</div>
                <div class="step-action">
                    <button onclick="doStep3AddConflict()">Add Conflict</button>
                </div>
            </div>

            <div class="step" id="step4">
                <span class="step-number">4</span>
                <span class="step-title">See the Difference</span>
                <div class="step-desc">Search again - notice the conflicting result.</div>
                <div class="step-action">
                    <button onclick="doStep4Search()">Search Again</button>
                </div>
            </div>

            <div class="step" id="step5">
                <span class="step-number">5</span>
                <span class="step-title">Roll Back to Main</span>
                <div class="step-desc">Switch to main - conflict is gone. Time travel!</div>
                <div class="step-action">
                    <button onclick="doStep5Rollback()">Switch to Main</button>
                </div>
            </div>

            <div style="margin-top: 2rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.375rem; font-size: 0.7rem; color: var(--text-muted);">
                <strong>TL;DR:</strong> TiDB stores vectors + text + JSON in one table. Branching is just a WHERE clause. No Pinecone + Postgres + Redis stack needed.
            </div>
        </div>

        <!-- Left Panel: Branch + Memories -->
        <div class="panel">
            <div class="panel-title">Branch & Memories</div>

            <div class="branch-indicator" id="branchIndicator">
                <span class="branch-dot"></span>
                <span class="branch-name" id="branchName">main</span>
                <span class="branch-label" id="branchLabel">production</span>
            </div>
            <select id="branchSelect" onchange="switchBranch()" class="branch-select">
                <option value="main">main</option>
            </select>

            <div id="memoryList">
                <div class="empty">Loading...</div>
            </div>

            <div class="sql-toggle" onclick="toggleSql('listSql')">
                <span>Show SQL</span>
                <span style="display: flex; align-items: center; gap: 0.5rem;">
                    <button class="copy-btn" onclick="event.stopPropagation(); copySql('listSql')">Copy</button>
                    <span id="listSqlArrow">+</span>
                </span>
            </div>
            <div class="sql-content" id="listSql"></div>
        </div>

        <!-- Middle Panel: Add Memory -->
        <div class="panel">
            <div class="panel-title">Add Memory</div>

            <div class="form-group">
                <label>Memory Text</label>
                <textarea id="memoryText" placeholder="e.g., User prefers museums over beaches"></textarea>
            </div>

            <div class="form-group">
                <label>Source</label>
                <select id="memorySource">
                    <option value="chat">Chat</option>
                    <option value="user">User Input</option>
                    <option value="doc">Document</option>
                </select>
            </div>

            <div class="form-group">
                <label>Tags</label>
                <input type="text" id="memoryTags" placeholder="preference, travel">
            </div>

            <button class="btn-primary" onclick="addMemory()">Add to Current Branch</button>

            <div class="sql-toggle" onclick="toggleSql('addSql')" style="margin-top: 1rem;">
                <span>Show SQL</span>
                <span style="display: flex; align-items: center; gap: 0.5rem;">
                    <button class="copy-btn" onclick="event.stopPropagation(); copySql('addSql')">Copy</button>
                    <span id="addSqlArrow">+</span>
                </span>
            </div>
            <div class="sql-content" id="addSql"></div>
        </div>

        <!-- Right Panel: Search -->
        <div class="panel">
            <div class="panel-title">Search</div>

            <div class="search-area" id="searchArea">
                <div class="form-group">
                    <label>Query</label>
                    <input type="text" id="searchQuery" placeholder="e.g., travel tips, hotel preferences" onkeypress="if(event.key==='Enter')searchMemories()">
                </div>

                <div class="search-modes">
                    <button class="mode-btn active" data-mode="hybrid" onclick="setMode('hybrid')">Hybrid</button>
                    <button class="mode-btn" data-mode="vector" onclick="setMode('vector')">Vector</button>
                    <button class="mode-btn" data-mode="fulltext" onclick="setMode('fulltext')">Fulltext</button>
                </div>

                <button class="btn-primary" onclick="searchMemories()">Search</button>
            </div>

            <div id="searchResults" style="margin-top: 1rem;">
                <div class="empty">Enter a query above</div>
            </div>

            <div class="sql-toggle" onclick="toggleSql('searchSql')" style="margin-top: 1rem;">
                <span>Show SQL</span>
                <span style="display: flex; align-items: center; gap: 0.5rem;">
                    <button class="copy-btn" onclick="event.stopPropagation(); copySql('searchSql')">Copy</button>
                    <span id="searchSqlArrow">+</span>
                </span>
            </div>
            <div class="sql-content" id="searchSql"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Bottom info box - explains the TiDB magic -->
    <div class="info-box">
        <div class="item">
            <span class="icon">üß†</span>
            <span><span class="highlight">Vectors + Text + JSON</span> in one row</span>
        </div>
        <div class="item">
            <span class="icon">üåø</span>
            <span>Branching = <span class="highlight">WHERE branch = '...'</span></span>
        </div>
        <div class="item">
            <span class="icon">üö´</span>
            <span>No Pinecone + Postgres + Redis stack</span>
        </div>
        <div class="item">
            <span class="icon">‚òÅÔ∏è</span>
            <span>Runs on <span class="highlight">TiDB Cloud</span> or local Docker</span>
        </div>
    </div>

    <!-- Timeline notice - shows when switching branches -->
    <div class="timeline-notice" id="timelineNotice">
        <div class="icon">‚è™</div>
        <div>Timeline restored</div>
        <div><span class="branch-name" id="timelineBranch">main</span> branch active</div>
    </div>

    <script>
        // State
        let currentBranch = 'main';
        let searchMode = 'hybrid';
        let currentStep = 1;
        let experimentBranch = null;
        const userId = 'demo-user';

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            loadTheme();
            await seedData();
            await loadBranches();
            await loadMemories();
        });

        // ============================================================
        // Tutorial Steps
        // ============================================================

        function setStep(n) {
            // Update step cards: mark completed, active, or pending
            for (let i = 1; i <= 5; i++) {
                const el = document.getElementById('step' + i);
                el.classList.remove('active', 'completed');
                if (i < n) el.classList.add('completed');
                if (i === n) el.classList.add('active');
            }

            // Update progress bar segments
            const segments = document.querySelectorAll('.progress-segment');
            segments.forEach((seg, idx) => {
                seg.classList.remove('done', 'current');
                if (idx < n - 1) seg.classList.add('done');      // completed steps
                if (idx === n - 1) seg.classList.add('current'); // current step
            });

            // Update "Step X of 5" counter
            document.getElementById('stepCounter').textContent = `Step ${n} of 5`;

            currentStep = n;
        }

        async function doStep1Search() {
            document.getElementById('searchQuery').value = 'vacation recommendations';
            await searchMemories();
            setStep(2);
        }

        async function doStep2Fork() {
            // Create experiment branch
            const res = await fetch('/api/branches/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, tag: 'experiment', source_branch: 'main' })
            });
            const data = await res.json();
            experimentBranch = data.new_branch;
            currentBranch = experimentBranch;

            await loadBranches();
            document.getElementById('branchSelect').value = currentBranch;
            updateBranchIndicator();
            await loadMemories();

            // Flash the branch indicator to show something changed
            const indicator = document.getElementById('branchIndicator');
            indicator.classList.add('flash');
            setTimeout(() => indicator.classList.remove('flash'), 500);

            // Show timeline notice for forward jump
            showTimelineNotice(experimentBranch);

            setStep(3);

            // Pre-fill the conflict text
            document.getElementById('memoryText').value = 'User hates beaches and wants mountain hiking only';
            document.getElementById('memorySource').value = 'chat';
            document.getElementById('memoryTags').value = 'conflict';
        }

        async function doStep3AddConflict() {
            await addMemory();
            setStep(4);
        }

        async function doStep4Search() {
            document.getElementById('searchQuery').value = 'vacation recommendations';
            await searchMemories();
            setStep(5);
        }

        async function doStep5Rollback() {
            currentBranch = 'main';
            document.getElementById('branchSelect').value = 'main';
            updateBranchIndicator();
            await loadMemories();

            // Show the timeline notice - this is the "time travel" moment
            showTimelineNotice('main');

            // Search again to show difference
            document.getElementById('searchQuery').value = 'vacation recommendations';
            await searchMemories();

            setStep(1); // Reset for replay
        }

        // ============================================================
        // Seed & Reset
        // ============================================================

        async function seedData() {
            try {
                await fetch('/api/seed', { method: 'POST' });
            } catch (e) {}
        }

        async function resetDemo() {
            if (!confirm('Reset demo? This deletes all memories and starts fresh.')) return;

            await fetch('/api/reset', { method: 'POST' });
            currentBranch = 'main';
            experimentBranch = null;
            await loadBranches();
            document.getElementById('branchSelect').value = 'main';
            updateBranchIndicator();
            await loadMemories();

            // Clear search
            document.getElementById('searchQuery').value = '';
            document.getElementById('searchResults').innerHTML = '<div class="empty">Enter a query above</div>';

            setStep(1);
            toast('Demo reset');
        }

        // ============================================================
        // Branch Management
        // ============================================================

        async function loadBranches() {
            const res = await fetch('/api/branches?user_id=' + userId);
            const data = await res.json();

            const select = document.getElementById('branchSelect');
            select.innerHTML = data.branches.map(b =>
                `<option value="${b}" ${b === currentBranch ? 'selected' : ''}>${b}</option>`
            ).join('');
        }

        function switchBranch() {
            currentBranch = document.getElementById('branchSelect').value;
            updateBranchIndicator();
            loadMemories();
            showTimelineNotice(currentBranch);
        }

        function updateBranchIndicator() {
            const indicator = document.getElementById('branchIndicator');
            const nameEl = document.getElementById('branchName');
            const labelEl = document.getElementById('branchLabel');

            nameEl.textContent = currentBranch;

            if (currentBranch !== 'main') {
                indicator.classList.add('experiment');
                labelEl.textContent = 'testing'; // orange badge
            } else {
                indicator.classList.remove('experiment');
                labelEl.textContent = 'production'; // green badge
            }
        }

        // ============================================================
        // Memory List
        // ============================================================

        async function loadMemories() {
            const res = await fetch(`/api/memories?user_id=${userId}&branch=${currentBranch}`);
            const data = await res.json();

            const list = document.getElementById('memoryList');

            if (data.memories.length === 0) {
                list.innerHTML = '<div class="empty">No memories in this branch</div>';
            } else {
                list.innerHTML = data.memories.map(m => {
                    // Detect conflicting memories (e.g., "hates beaches")
                    const isConflict = m.text.toLowerCase().includes('hates');
                    return `
                        <div class="memory-item ${isConflict ? 'conflict' : ''}">
                            <div>${escapeHtml(m.text)}</div>
                            <div class="memory-meta">
                                ${isConflict ? '<span class="badge badge-conflict">conflict</span>' : ''}
                                ${m.metadata?.source ? `<span class="badge badge-source">${m.metadata.source}</span>` : ''}
                                ${(m.metadata?.tags || []).map(t => `<span class="badge badge-tag">${t}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            setSql('listSql', data.sql_used);
        }

        // ============================================================
        // Add Memory
        // ============================================================

        async function addMemory() {
            const textEl = document.getElementById('memoryText');
            const text = textEl.value.trim();
            if (!text) { toast('Enter memory text', 'error'); return; }

            const source = document.getElementById('memorySource').value;
            const tags = document.getElementById('memoryTags').value;

            const res = await fetch('/api/memories', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, text, source, tags, branch: currentBranch })
            });

            const data = await res.json();
            const isConflict = text.toLowerCase().includes('hates');

            textEl.value = '';
            document.getElementById('memoryTags').value = '';
            await loadMemoriesWithHighlight(data.id, isConflict);

            toast(isConflict ? 'Conflict added!' : 'Memory added');
            setSql('addSql', data.sql_used);
        }

        // Load memories and highlight the newest one
        async function loadMemoriesWithHighlight(newId, isConflict) {
            const res = await fetch(`/api/memories?user_id=${userId}&branch=${currentBranch}`);
            const data = await res.json();

            const list = document.getElementById('memoryList');

            if (data.memories.length === 0) {
                list.innerHTML = '<div class="empty">No memories in this branch</div>';
            } else {
                list.innerHTML = data.memories.map(m => {
                    const memIsConflict = m.text.toLowerCase().includes('hates');
                    const isNew = m.id === newId;
                    return `
                        <div class="memory-item ${memIsConflict ? 'conflict' : ''} ${isNew ? 'new' : ''}">
                            <div>${escapeHtml(m.text)}</div>
                            <div class="memory-meta">
                                ${memIsConflict ? '<span class="badge badge-conflict">conflict</span>' : ''}
                                ${m.metadata?.source ? `<span class="badge badge-source">${m.metadata.source}</span>` : ''}
                                ${(m.metadata?.tags || []).map(t => `<span class="badge badge-tag">${t}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            setSql('listSql', data.sql_used);
        }

        // ============================================================
        // Search
        // ============================================================

        function setMode(mode) {
            searchMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
        }

        async function searchMemories() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) { toast('Enter a search query', 'error'); return; }

            // Yellow highlight around search area
            const searchArea = document.getElementById('searchArea');
            searchArea.classList.remove('highlight');
            void searchArea.offsetWidth; // Force reflow to restart animation
            searchArea.classList.add('highlight');

            const res = await fetch('/api/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, query, mode: searchMode, top_k: 5, branch: currentBranch })
            });

            const data = await res.json();
            const results = document.getElementById('searchResults');

            // Flash the results area
            results.classList.add('results-flash');
            setTimeout(() => results.classList.remove('results-flash'), 500);

            if (data.results.length === 0) {
                results.innerHTML = '<div class="empty">No results</div>';
            } else {
                results.innerHTML = data.results.map(r => {
                    const isConflict = r.text.toLowerCase().includes('hates');
                    return `
                        <div class="search-result ${isConflict ? 'conflict' : ''}">
                            <div class="result-score">${(r.score * 100).toFixed(0)}% match</div>
                            <div class="score-bar"><div class="score-fill" style="width: ${r.score * 100}%"></div></div>
                            <div class="result-text">${escapeHtml(r.text)}</div>
                        </div>
                    `;
                }).join('');
            }

            setSql('searchSql', data.sql_used);
        }

        // ============================================================
        // Utils
        // ============================================================

        function toggleSql(id) {
            const el = document.getElementById(id);
            const arrow = document.getElementById(id + 'Arrow');
            const toggle = el.previousElementSibling; // the .sql-toggle div

            el.classList.toggle('visible');
            toggle.classList.toggle('open'); // adjusts border-radius when open
            arrow.textContent = el.classList.contains('visible') ? '‚àí' : '+';
        }

        // Simple SQL syntax highlighting - makes keywords pop
        function highlightSql(sql) {
            const keywords = ['SELECT', 'FROM', 'WHERE', 'AND', 'OR', 'ORDER BY', 'LIMIT', 'INSERT', 'INTO', 'VALUES', 'DELETE', 'UPDATE', 'SET', 'JOIN', 'LEFT', 'RIGHT', 'INNER', 'ON', 'AS', 'DISTINCT', 'ASC', 'DESC', 'GROUP BY', 'HAVING'];
            let highlighted = escapeHtml(sql);

            // Highlight SQL keywords (case-insensitive, but display uppercase)
            keywords.forEach(kw => {
                const regex = new RegExp(`\\b${kw}\\b`, 'gi');
                highlighted = highlighted.replace(regex, `<span class="keyword">${kw}</span>`);
            });

            // Highlight strings in single quotes
            highlighted = highlighted.replace(/'([^']*)'/g, `<span class="string">'$1'</span>`);

            // Highlight comments (-- style)
            highlighted = highlighted.replace(/(--.*?)(\n|$)/g, `<span class="comment">$1</span>$2`);

            return highlighted;
        }

        // Set SQL content with syntax highlighting
        function setSql(id, sql) {
            const el = document.getElementById(id);
            el.innerHTML = highlightSql(sql);
            el.dataset.rawSql = sql; // store raw SQL for copy
        }

        // Copy SQL to clipboard
        async function copySql(id) {
            const el = document.getElementById(id);
            const sql = el.dataset.rawSql || el.textContent;

            try {
                await navigator.clipboard.writeText(sql);
                // Find the copy button and show feedback
                const btn = el.previousElementSibling.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('copied');
                }, 1500);
            } catch (err) {
                toast('Failed to copy', 'error');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toast(msg, type = 'success') {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.className = 'toast visible ' + type;
            setTimeout(() => el.classList.remove('visible'), 2500);
        }

        // Show centered timeline notice when switching branches
        function showTimelineNotice(branchName) {
            const notice = document.getElementById('timelineNotice');
            const branchEl = document.getElementById('timelineBranch');
            branchEl.textContent = branchName;

            // Update icon based on direction
            const iconEl = notice.querySelector('.icon');
            iconEl.textContent = branchName === 'main' ? '‚è™' : '‚è©';

            notice.classList.add('visible');
            setTimeout(() => notice.classList.remove('visible'), 1800);
        }

        function loadTheme() {
            if (localStorage.getItem('theme') === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            if (html.getAttribute('data-theme') === 'dark') {
                html.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            } else {
                html.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
        }
    </script>
</body>
</html>
